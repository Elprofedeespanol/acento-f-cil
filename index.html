<script>
  // Diccionario b√°sico franc√©s
  const diccionarioFrances = {
    "caf√©": "caf√©", "jam√≥n": "jambon", "comer": "manger", "f√°cil": "facile",
    "casa": "maison", "tel√©fono": "t√©l√©phone", "m√∫sica": "musique", 
    "d√≠ganselo": "dites-le-lui", "ac√©rcate": "approche-toi", "qu√≠temelo": "enlevez-le-le",
    "paralelep√≠pedo": "parall√©l√©pip√®de"
  };

  // Lista de palabras que SIEMPRE deben llevar tilde (esdr√∫julas y sobreesdr√∫julas)
  const palabrasConTildeFija = [
    "tel√©fono", "m√∫sica", "f√°cil", "c√°scara", "r√°pido", "paralelep√≠pedo",
    "d√≠ganselo", "ac√©rcate", "qu√≠temelo", "estad√≠sticas", "s√≠laba", "r√©gimen",
    "g√©nero", "n√∫mero", "gram√°tica", "esdr√∫jula", "sobreesdr√∫jula"
  ];

  // Funci√≥n de an√°lisis corregida
  function analizarPalabra(palabra) {
    palabra = palabra.toLowerCase().trim();
    const silabas = silabear(palabra);
    const numSilabas = silabas.length;

    if (numSilabas === 0) {
      return { error: "Palabra no v√°lida" };
    }

    // Detectar si tiene tilde escrita
    const tieneTilde = /√°|√©|√≠|√≥|√∫/.test(palabra);

    // === PASO 1: Encontrar la s√≠laba T√ìNICA (por reglas pros√≥dicas) ===
    let tonica;
    const ultimaLetra = palabra.slice(-1);
    const terminaEnVNS = ['a','e','i','o','u','n','s'].includes(ultimaLetra);

    if (terminaEnVNS) {
      tonica = numSilabas - 2; // pen√∫ltima
    } else {
      tonica = numSilabas - 1; // √∫ltima
    }

    // Si tiene tilde escrita, el acento sigue la tilde
    if (tieneTilde) {
      for (let i = 0; i < silabas.length; i++) {
        if (/√°|√©|√≠|√≥|√∫/.test(silabas[i])) {
          tonica = i;
          break;
        }
      }
    }

    // Asegurar que la posici√≥n sea v√°lida
    if (tonica < 0) tonica = 0;
    if (tonica >= numSilabas) tonica = numSilabas - 1;

    // === PASO 2: Clasificar tipo ===
    let tipo;
    if (tonica === numSilabas - 1) {
      tipo = 'aguda';
    } else if (tonica === numSilabas - 2) {
      tipo = 'grave';
    } else if (tonica === numSilabas - 3) {
      tipo = 'esdr√∫jula';
    } else {
      tipo = 'sobreesdr√∫jula';
    }

    // === PASO 3: ¬øDebe llevar tilde? (reglas ortogr√°ficas) ===
    let debeTilde = false;

    // Regla 1: Agudas ‚Üí tilde si terminan en vocal, n, s
    if (tipo === 'aguda' && terminaEnVNS) {
      debeTilde = true;
    }
    // Regla 2: Graves ‚Üí tilde si NO terminan en vocal, n, s
    else if (tipo === 'grave' && !terminaEnVNS) {
      debeTilde = true;
    }
    // Regla 3: Esdr√∫julas y sobreesdr√∫julas ‚Üí SIEMPRE llevan tilde
    else if (tipo === 'esdr√∫jula' || tipo === 'sobreesdr√∫jula') {
      debeTilde = true;
    }

    // EXCEPCI√ìN: Si la palabra est√° en la lista de esdr√∫julas, debe llevar tilde
    // Ejemplo: paralelep√≠pedo ‚Üí aunque el usuario escriba "paralelepipedo", debe tener tilde
    if (palabrasConTildeFija.includes(palabra) || palabrasConTildeFija.some(p => p.startsWith(palabra))) {
      debeTilde = true;
    }

    // === PASO 4: ¬øEl usuario escribi√≥ bien? ===
    // Solo est√° bien si:
    // - Tiene tilde y debe tenerla
    // - No tiene tilde y no debe tenerla
    const escribioBien = (tieneTilde && debeTilde) || (!tieneTilde && !debeTilde);

    // === PASO 5: Mensaje de regla ===
    let regla = '';
    if (tipo === 'aguda') {
      regla = debeTilde 
        ? 'Lleva tilde porque termina en vocal, n o s y el acento est√° en la √∫ltima s√≠laba.' 
        : 'No lleva tilde porque termina en consonante (no n ni s).';
    } else if (tipo === 'grave') {
      regla = debeTilde 
        ? 'Lleva tilde porque NO termina en vocal, n o s.' 
        : 'No lleva tilde porque termina en vocal, n o s.';
    } else if (tipo === 'esdr√∫jula') {
      regla = 'Las palabras esdr√∫julas siempre llevan tilde, sin excepci√≥n.';
    } else {
      regla = 'Las palabras sobreesdr√∫julas siempre llevan tilde.';
    }

    // === CORRECCI√ìN: Si es esdr√∫jula pero no tiene tilde, obligar a corregir ===
    if (tipo === 'esdr√∫jula' && !tieneTilde) {
      regla += ' ‚ùå Escribe la palabra con tilde (ej: paralelep√≠pedo).';
    }

    return {
      palabra: palabra,
      silabas: silabas,
      tonica: tonica,
      tipo: tipo,
      debe_tilde: debeTilde,
      tiene_tilde: tieneTilde,
      escribio_bien: escribioBien,
      regla: regla,
      traduccion: diccionarioFrances[palabra] || 'no disponible',
      silabasTexto: silabas.map((s, i) => i === tonica ? `**${s}**` : s).join(' - ')
    };
  }

  // === FUNCI√ìN DE SILABEO MEJORADA ===
  function silabear(palabra) {
    const fuertes = 'aeo√°√©√≥';
    const debiles = 'iu√≠√∫√º';
    const todas = 'aeiou√°√©√≠√≥√∫√º';
    let silabas = [];
    let actual = '';
    let i = 0;

    while (i < palabra.length) {
      let c = palabra[i];

      // Reglas de diptongo/hiato
      if (todas.includes(c)) {
        actual += c;
        let siguiente = i + 1 < palabra.length ? palabra[i + 1] : '';

        // Diptongo: vocal d√©bil + fuerte o viceversa (excepto con acento)
        if (debiles.includes(c) && fuertes.includes(siguiente)) {
          actual += siguiente;
          i++;
        } else if (fuertes.includes(c) && debiles.includes(siguiente)) {
          // Pero si la d√©bil lleva tilde ‚Üí hiato
          if (['√≠','√∫'].includes(siguiente)) {
            silabas.push(actual);
            actual = siguiente;
          } else {
            actual += siguiente;
            i++;
          }
        } else if (debiles.includes(c) && debiles.includes(siguiente)) {
          actual += siguiente;
          i++;
        } else {
          // Fin de s√≠laba
          if (actual) {
            silabas.push(actual);
            actual = '';
          }
        }
      } else {
        // Consonante
        if (actual && !todas.includes(actual[actual.length - 1])) {
          actual += c;
        } else {
          if (actual) {
            silabas.push(actual);
            actual = '';
          }
          actual = c;
        }
      }
      i++;
    }

    if (actual) silabas.push(actual);
    return silabas;
  }

  // === FUNCIONES DE LA APP ===
  window.speechSynthesis.getVoices();

  function analizar() {
    const palabra = document.getElementById("entrada").value.trim();
    if (!palabra) return;

    const result = analizarPalabra(palabra);
    const resDiv = document.getElementById("resultado");
    const guardarDiv = document.getElementById("guardado");

    if (result.error) {
      resDiv.innerHTML = `<p style="color:red">${result.error}</p>`;
      return;
    }

    let html = `
      <div class="resultado">
        <p><strong>Palabra:</strong> ${result.palabra}</p>
        <p><strong>S√≠labas:</strong> <span class="silabas">${result.silabasTexto}</span></p>
        <p><strong>Tipo:</strong> ${result.tipo}</p>
        <p><strong>¬øLleva tilde?</strong> ${result.debe_tilde ? 'S√≠' : 'No'}</p>
        <p><strong>Regla:</strong> ${result.regla}</p>
        <p><strong>Franc√©s:</strong> ${result.traduccion}</p>
        <p><button onclick="pronunciar('${result.palabra}')">üîä Pronunciar</button></p>
        <p class="${result.escribio_bien ? 'correcta' : 'incorrecta'}">
          ${result.escribio_bien ? '‚úÖ Escritura correcta' : '‚ùå Corrige la tilde'}
        </p>
      </div>
    `;
    resDiv.innerHTML = html;

    // Solo mostrar bot√≥n de guardar si escribi√≥ bien Y la palabra es correcta
    if (result.escribio_bien) {
      guardarDiv.innerHTML = `
        <button class="boton-guardar" onclick="guardarPalabra('${result.palabra}')">
          Guardar en mi lista
        </button>
      `;
    } else {
      guardarDiv.innerHTML = "";
    }

    mostrarLista();
  }

  function pronunciar(texto) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(texto);
    utterance.lang = 'es-ES';
    utterance.rate = 0.9;
    utterance.pitch = 1;
    const voces = window.speechSynthesis.getVoices();
    const voz = voces.find(v => v.lang.startsWith('es'));
    if (voz) utterance.voice = voz;
    window.speechSynthesis.speak(utterance);
  }

  function guardarPalabra(palabra) {
    let lista = JSON.parse(localStorage.getItem("listaAcentoFacil") || "[]");
    if (!lista.includes(palabra)) {
      lista.push(palabra);
      localStorage.setItem("listaAcentoFacil", JSON.stringify(lista));
      alert("¬°Palabra guardada!");
      mostrarLista();
    } else {
      alert("Ya guardaste esta palabra.");
    }
  }

  function mostrarLista() {
    let lista = JSON.parse(localStorage.getItem("listaAcentoFacil") || "[]");
    const cont = document.getElementById("lista-personal");
    cont.innerHTML = lista.length === 0 
      ? "<p>Ninguna palabra guardada.</p>"
      : lista.map(p => `<div class="palabra-item">${p}</div>`).join('');
  }

  mostrarLista();
</script>

    function mostrarLista() {
      let lista = JSON.parse(localStorage.getItem("listaAcentoFacil") || "[]");
      const cont = document.getElementById("lista-personal");
      cont.innerHTML = lista.length === 0 
        ? "<p>Ninguna palabra guardada.</p>"
        : lista.map(p => `<div class="palabra-item">${p}</div>`).join('');
    }

    mostrarLista();
  </script>
</body>
</html>
